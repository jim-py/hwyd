import random
from celery import shared_task
from django.contrib.auth import get_user_model
from webpush.models import PushInformation
from webpush import send_user_notification

User = get_user_model()

MORNING_MESSAGES = [
    "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –ù–æ–≤—ã–π –¥–µ–Ω—å ‚Äî –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏!",
    "–ù–∞—á–Ω–∏ –¥–µ–Ω—å —Å —É–ª—ã–±–∫–∏ –∏ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è!",
    "–ö–∞–∂–¥—ã–π –¥–µ–Ω—å ‚Äî —ç—Ç–æ —à–∞–≥ –∫ —Ç–≤–æ–µ–π —Ü–µ–ª–∏. –í–ø–µ—Ä—ë–¥!",
    "–ü—Ä–æ—Å–Ω–∏—Å—å –∏ —Å–∏—è–π! –¢–≤–æ–π —É—Å–ø–µ—Ö –∂–¥—ë—Ç —Ç–µ–±—è.",
    "–°–µ–≥–æ–¥–Ω—è –æ—Ç–ª–∏—á–Ω—ã–π –¥–µ–Ω—å –¥–ª—è –Ω–æ–≤—ã—Ö –ø—Ä–∏–≤—ã—á–µ–∫!",
    "–¢—ã —Å–∏–ª—å–Ω–µ–µ, —á–µ–º –¥—É–º–∞–µ—à—å. –ù–∞—á–Ω–∏ —Å–µ–≥–æ–¥–Ω—è!",
    "–í–µ—Ä—å –≤ —Å–µ–±—è –∏ –¥–æ—Å—Ç–∏–≥–∞–π –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ–≥–æ!",
    "–ù–æ–≤—ã–π –¥–µ–Ω—å ‚Äî –Ω–æ–≤–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å—Ç–∞—Ç—å –ª—É—á—à–µ.",
    "–ó–∞—Ä—è–¥–∏ —Å–µ–±—è –ø–æ–∑–∏—Ç–∏–≤–æ–º –∏ –≤–ø–µ—Ä–µ–¥ –∫ —Ü–µ–ª—è–º!",
    "–ù–µ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–π –Ω–∞ –∑–∞–≤—Ç—Ä–∞ —Ç–æ, —á—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è.",
    "–£–ª—ã–±–Ω–∏—Å—å –∏ –ø—É—Å—Ç—å –¥–µ–Ω—å –±—É–¥–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ã–º!",
    "–¢–≤–æ—è –ø—Ä–∏–≤—ã—á–∫–∞ ‚Äî —Ç–≤–æ—è —Å–∏–ª–∞. –î–µ—Ä–∂–∏—Å—å!",
    "–°–¥–µ–ª–∞–π —Å–µ–≥–æ–¥–Ω—è —Ç–æ, —á—Ç–æ –¥—Ä—É–≥–∏–µ –Ω–µ —Ö–æ—Ç—è—Ç, —á—Ç–æ–±—ã –∑–∞–≤—Ç—Ä–∞ –±—ã—Ç—å —É—Å–ø–µ—à–Ω—ã–º.",
    "–ö–∞–∂–¥—ã–π –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ ‚Äî —ç—Ç–æ –±–æ–ª—å—à–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å.",
    "–¢—ã –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø—É—Ç–∏, –ø—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!",
    "–ü—É—Å—Ç—å –º–æ—Ç–∏–≤–∞—Ü–∏—è –±—É–¥–µ—Ç —Ç–≤–æ–∏–º —Ç–æ–ø–ª–∏–≤–æ–º —Å–µ–≥–æ–¥–Ω—è.",
    "–î–µ–π—Å—Ç–≤—É–π —Å–µ–π—á–∞—Å ‚Äî —Ç–≤–æ–µ –±—É–¥—É—â–µ–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —ç—Ç–æ–≥–æ.",
    "–°–µ–≥–æ–¥–Ω—è —Ç–≤–æ–π –¥–µ–Ω—å. –ò—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ –ø–æ –º–∞–∫—Å–∏–º—É–º—É!",
    "–ù–µ –±–æ–π—Å—è –æ—à–∏–±–æ–∫, –æ–Ω–∏ —á–∞—Å—Ç—å —É—Å–ø–µ—Ö–∞.",
    "–ö–∞–∂–¥–æ–µ —É—Ç—Ä–æ ‚Äî —ç—Ç–æ —à–∞–Ω—Å –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ."
]

def send_push(user, title, body, ttl=6*60*60):
    """
    –û—Ç–ø—Ä–∞–≤–∫–∞ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
    """
    try:
        send_user_notification(
            user=user,
            payload={
                "title": title,
                "body": body,
            },
            ttl=ttl
        )
    except Exception as e:
        # –õ–æ–≥–∏—Ä—É–π –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è {user}: {e}")

@shared_task
def send_daily_push():
    """
    –ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å –ø–æ–¥–ø–∏—Å–∫–∞–º–∏.
    """
    subs = PushInformation.objects.select_related('user').all()
    users = {sub.user for sub in subs}

    for user in users:
        send_push(
            user=user,
            title="–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ",
            body="–ó–∞–π–¥–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ üëã",
            ttl=86400
        )

@shared_task
def send_morning_motivation():
    """
    –û—Ç–ø—Ä–∞–≤–∫–∞ —É—Ç—Ä–µ–Ω–Ω–∏—Ö –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã—Ö –ø—É—à–µ–π.
    """
    subs = PushInformation.objects.select_related('user').all()
    users = {sub.user for sub in subs}

    for user in users:
        message = random.choice(MORNING_MESSAGES)
        send_push(
            user=user,
            title="–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ!",
            body=message,
            ttl=6*60*60  # 6 —á–∞—Å–æ–≤
        )

@shared_task
def ping():
    print("CELERY OK")
    return 'pong'
