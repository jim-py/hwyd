{% load static %}
<!DOCTYPE html>
<html id="html" lang="ru">
<head>
    <title>Habitus</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <link rel="stylesheet" href="{% static 'css/tableCells.css' %}">
    <link rel="stylesheet" href="{% static 'css/buttons.css' %}">

    <script src="{% static 'js/jquery.js' %}"></script>

    <link rel="shortcut icon" type="image/png" href="{% static 'favicon.png' %}"/>
    
    {% include 'hwyd/styles.html' %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="manifest" href="{% static 'manifest_habitus.json' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@latest/dist/driver.css"/>
</head>
<body>

{% include 'notifications/modal_snippet.html' %}

{% if request.user_agent.is_mobile %}
    {% include 'navibarMobile.html' %}
{% else %}
    {% include 'navibar.html' %}
{% endif %}

{% include 'hwyd/dialogs.html' %}

{% include 'hwyd/table.html' %}

<script src="{% static 'js/jquery.min.js' %}"></script>
<script src="{% static 'js/jquery-ui.min.js' %}"></script>

<script>
window.IS_AUTHENTICATED = {{ request.user.is_authenticated|yesno:"true,false" }};

(async function () {
  console.log('[PUSH] init');

  if (!window.IS_AUTHENTICATED) {
    console.warn('[PUSH] user not authenticated');
    return;
  }

  if (
    !('Notification' in window) ||
    !('serviceWorker' in navigator) ||
    !('PushManager' in window)
  ) {
    console.warn('[PUSH] push not supported');
    return;
  }

  if (Notification.permission === 'granted') {
    await subscribe();
  } else {
    showPermissionButton();
  }

  async function subscribe() {
    console.log('[PUSH] registering service worker');
    await navigator.serviceWorker.register('/sw.js');

    const registration = await navigator.serviceWorker.ready;
    let subscription = await registration.pushManager.getSubscription();

    if (!subscription) {
      console.log('[PUSH] creating subscription');

      const VAPID_PUBLIC_KEY =
        'BB83EoTTC8cO73kgpsJqVBlSH1FrivQoHgG5hD33jXLbDAXiLBvb_PLzVbpeEed5keHXcSKPuYVMdoEZuzqSqME';

      subscription = await registration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
      });
    }

    const csrftoken = getCookie('csrftoken');
    if (!csrftoken) {
      console.error('[PUSH] CSRF token missing');
      return;
    }

    const payload = {
      subscription: subscription.toJSON(),
      browser: navigator.userAgent.slice(0, 100),
      user_agent: navigator.userAgent,
      status_type: 'subscribe',
      group: 'test'
    };

    console.log('[PUSH] sending subscription to backend');
    const response = await fetch('/webpush/save_information', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken
      },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      console.error('[PUSH] failed to save subscription on server');
    } else {
      console.log('[PUSH] subscription saved');
    }
  }

  function showPermissionButton() {
    if (document.getElementById('push-permission-btn')) return;

    const btn = document.createElement('button');
    btn.id = 'push-permission-btn';
    btn.textContent = 'Включить уведомления';
    btn.style.cssText = `
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      padding: 12px 16px;
      font-size: 16px;
      cursor: pointer;
    `;

    btn.onclick = async () => {
      console.log('[PUSH] permission requested by user click');
      const permission = await Notification.requestPermission();
      console.log('[PUSH] permission after click:', permission);

      if (permission === 'granted') {
        btn.remove();
        await subscribe();
      } else {
        console.warn('[PUSH] permission denied or dismissed');
      }
    };

    const isSuperuser = {{ user.is_superuser|yesno:"true,false" }};
    if (isSuperuser) {
      document.body.appendChild(btn);
    }
  }

  function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding)
      .replace(/-/g, '+')
      .replace(/_/g, '/');
    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) {
      outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie) {
      const cookies = document.cookie.split(';');
      for (const c of cookies) {
        const cookie = c.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
})();
</script>



<script src="https://cdn.jsdelivr.net/npm/driver.js@latest/dist/driver.js.iife.js"></script>


<script>
/* =====================================================
   CONFIG
===================================================== */

const GUIDE_SLUG = "main_toolbar";

const I18N = {
    next: "Далее",
    prev: "Назад",
    done: "Понятно",
    confirmClose: "Вы точно хотите прервать обучение?"
};


/* =====================================================
   CSRF (Django)
===================================================== */

let csrfTokenCache = null;

function getCSRFToken() {
    if (csrfTokenCache) return csrfTokenCache;

    const name = "csrftoken";
    const cookies = document.cookie.split(";");

    for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + "=")) {
            csrfTokenCache = decodeURIComponent(
                cookie.substring(name.length + 1)
            );
            return csrfTokenCache;
        }
    }
    return "";
}

function csrfHeaders() {
    return {
        "X-CSRFToken": getCSRFToken(),
        "Content-Type": "application/json"
    };
}


/* =====================================================
   FETCH HELPERS (единая точка работы с API)
===================================================== */

async function fetchJSON(url, options = {}) {
    const response = await fetch(url, options);

    if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
    }

    // если сервер вернул пустое тело
    const text = await response.text();
    return text ? JSON.parse(text) : {};
}

const GuidesAPI = {
    async shouldShow(slug) {
        const data = await fetchJSON(
            `/home/guides/${slug}/should-show/`
        );
        return data.show === true;
    },

    async markViewed(slug) {
        await fetchJSON(
            `/home/guides/${slug}/viewed/`,
            {
                method: "POST",
                headers: csrfHeaders()
            }
        );
    }
};


/* =====================================================
   TEMPORARY VISIBILITY HELPERS
===================================================== */

function forceShowHiddenButtons(selectors) {
    const modified = [];

    selectors.forEach(selector => {
        const el = document.querySelector(selector);
        if (!el) return;

        const computed = window.getComputedStyle(el);

        if (computed.display === "none" || el.hidden) {
            modified.push({
                el,
                originalDisplay: el.style.display,
                wasHidden: el.hidden
            });

            el.hidden = false;

            // не ломаем layout — используем block как безопасный fallback
            if (computed.display === "none") {
                el.style.display = "block";
            }
        }
    });

    return function restore() {
        modified.forEach(item => {
            item.el.hidden = item.wasHidden;
            item.el.style.display = item.originalDisplay;
        });
    };
}


/* =====================================================
   ONBOARDING STEPS (Font Awesome + bottom positioning)
===================================================== */

const ONBOARDING_STEPS = [
    /* =====================================================
      FINAL STEP / ЗАВЕРШЕНИЕ ОБУЧЕНИЯ
      (будет ПОСЛЕДНИМ из-за reverse())
    ===================================================== */
    {
        popover: {
            title: 'Готово!',
            description: `
                <i class="fa-solid fa-heart onboarding-icon"></i>
                Спасибо, что прошли короткое обучение!

                <br><br>

                Теперь вы знаете основные элементы управления
                трекером привычек и можете начать пользоваться
                приложением максимально эффективно.

                <br><br>

                <i class="fa-solid fa-gear onboarding-icon"></i>
                Помните — большинство кнопок можно включать
                или отключать в настройках под себя.

                <br><br>

                Желаем стабильных привычек,
                длинных стриков
                <i class="fa-solid fa-fire onboarding-icon"></i>
                и отличных результатов!
            `,
            side: "center",
            align: "center"
        }
    },

    /* ---------- НАСТРОЙКИ ---------- */
    {
        element: "#buttonSettings",
        popover: {
            title: '<i class="fa-solid fa-gear onboarding-icon"></i> Настройки',
            description:
                "Здесь находятся настройки отображения, поведения и внешний вид трекера привычек.",
            side: "bottom",
            align: "start"
        }
    },

    /* ---------- СКРЫТЬ ВЫПОЛНЕННЫЕ ---------- */
    {
        element: "#hideCompleteActivities",
        popover: {
            title: '<i class="fa-solid fa-eye onboarding-icon"></i> Выполненные привычки',
            description:
                "Позволяет скрыть выполненные привычки, чтобы сфокусироваться только на текущих.",
            side: "bottom",
            align: "center"
        }
    },

    /* ---------- ОЧИСТКА ---------- */
    {
        element: "#deleteAll",
        popover: {
            title: '<i class="fa-solid fa-trash onboarding-icon"></i> Очистить привычки',
            description:
                "Удаляет все привычки выбранного периода. Кнопка появляется только когда очистка доступна.",
            side: "bottom",
            align: "center"
        }
    },

    /* ---------- ГРУППЫ ---------- */
    {
        element: "#openAll",
        popover: {
            title: '<i class="fa-solid fa-folder-open onboarding-icon"></i> Управление группами',
            description:
                "Позволяет раскрыть или свернуть сразу все группы привычек.",
            side: "bottom",
            align: "center"
        }
    },

    /* ---------- КАЛЕНДАРЬ ---------- */
    {
        element: '.calendar-button[onclick*="calendarModal"]',
        popover: {
            title: '<i class="fa-solid fa-calendar onboarding-icon"></i> Календарь',
            description:
                "Быстрый переход к любому месяцу. Можно просматривать прошлые периоды.",
            side: "bottom",
            align: "center"
        }
    },

    /* ---------- ПОВТОР ПРОШЛОГО МЕСЯЦА ---------- */
    {
        element: "#btnActLastMonth",
        popover: {
            title: '<i class="fa-solid fa-clock-rotate-left onboarding-icon"></i> Повтор прошлого месяца',
            description:
                "Автоматически создаёт привычки на основе прошлого месяца. Кнопка появляется только когда привычек ещё нет.",
            side: "bottom",
            align: "center"
        }
    },

    /* ---------- СОЗДАТЬ ПРИВЫЧКУ ---------- */
    {
        element: '.calendar-button[title="Создать активность"]',
        popover: {
            title: '<i class="fa-solid fa-plus onboarding-icon"></i> Новая привычка',
            description:
                "Создаёт новую привычку или задачу, которую вы хотите отслеживать.",
            side: "bottom",
            align: "center"
        }
    },

    /* ---------- СОЗДАТЬ ГРУППУ ---------- */
    {
        element: '.calendar-button[title="Создать группу"]',
        popover: {
            title: '<i class="fa-solid fa-layer-group onboarding-icon"></i> Группа привычек',
            description:
                "Позволяет объединять привычки в группы для удобной организации.",
            side: "bottom",
            align: "center"
        }
    },

    /* ---------- СТРИК ---------- */
    {
        element: "#loginStreak",
        popover: {
            title: '<i class="fa-solid fa-fire onboarding-icon"></i> Стрик посещений',
            description:
                "Показывает, сколько дней подряд вы заходите в приложение. Не прерывайте цепочку!",
            side: "bottom",
            align: "end"
        }
    },

    /* ---------- INTRO / ДОБРО ПОЖАЛОВАТЬ ---------- */
    {
        popover: {
            title: '<i class="fa-solid fa-hand-sparkles onboarding-icon"></i> Добро пожаловать!',
            description: `
                Сейчас мы коротко покажем основные кнопки управления трекером привычек.

                <br><br>

                <i class="fa-solid fa-gear onboarding-icon"></i> Некоторые кнопки могут быть отключены в настройках.
                Во время обучения они временно отображаются, чтобы вы могли
                увидеть все возможности интерфейса.

                <br><br>

                Вы всегда можете включить или скрыть их позже в настройках.
            `,
            side: "center",
            align: "center"
        }
    },
];


/* =====================================================
   ONBOARDING LOGIC
===================================================== */

let onboardingStarted = false;

function validateSteps(steps) {
    return steps.filter(step => {

        if (!step.element) {
            return true;
        }

        const exists = document.querySelector(step.element);

        if (!exists) {
            console.warn("Onboarding element not found:", step.element);
        }

        return exists;
    });
}

function startOnboarding() {
    if (onboardingStarted) return;
    onboardingStarted = true;

    const driver = window.driver?.js?.driver;

    if (!driver) {
        console.error("Driver.js не найден");
        return;
    }

    /* временно показываем скрытые кнопки */
    const restoreButtons = forceShowHiddenButtons([
        "#deleteAll",
        "#openAll",
        "#createLastMonthActivitiesForm",
        "#createActivityButton",
        "#createGroupButton",
        "#calendarButton"
    ]);

    const tour = driver({

        /* UI */
        showProgress: false,
        allowClose: false,

        nextBtnText: I18N.next,
        prevBtnText: I18N.prev,
        doneBtnText: I18N.done,

        overlayOpacity: 0.65,
        stagePadding: 8,
        stageRadius: 10,
        popoverClass: "onboarding-popover",
        popoverOffset: window.innerWidth < 640 ? 20 : 12,

        onHighlightStarted: (element, step, { state }) => {

            if (!onboardingStartedCheck) {
                onboardingStartedCheck = true;
                enableOnboardingLock();
            }
        },

        onDestroyed: async () => {
            restoreButtons();

            try {
                await GuidesAPI.markViewed(GUIDE_SLUG);
            } catch (e) {
                console.error("Ошибка сохранения просмотра:", e);
            }

            disableOnboardingLock();
        },

        onCloseClick: () => {
            if (confirm(I18N.confirmClose)) {
                tour.destroy();
            }
        }
    });

    const REVERSED_ONBOARDING_STEPS = [...ONBOARDING_STEPS].reverse();
    const validSteps = validateSteps(REVERSED_ONBOARDING_STEPS);

    if (!validSteps.length) {
        console.warn("Нет доступных шагов onboarding");
        return;
    }

    tour.setSteps(validSteps);
    tour.drive();
}


/* =====================================================
   ONBOARDING INTERACTION LOCK
===================================================== */

let onboardingStartedCheck = false;

function enableOnboardingLock() {
    document.body.classList.add("onboarding-lock");
}

function disableOnboardingLock() {
    document.body.classList.remove("onboarding-lock");
    onboardingStartedCheck = false;
}

/* --- глобальный перехват событий toolbar --- */

function blockToolbarEvents(e) {

    if (!document.body.classList.contains("onboarding-lock"))
        return;

    const toolbar = e.target.closest("#divButtons");
    if (!toolbar) return;

    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();

    return false;
}

/* capture phase — раньше onclick */
document.addEventListener("click", blockToolbarEvents, true);
document.addEventListener("submit", blockToolbarEvents, true);
document.addEventListener("mousedown", blockToolbarEvents, true);
document.addEventListener("touchstart", blockToolbarEvents, true);


/* =====================================================
   AUTO START
===================================================== */

document.addEventListener("DOMContentLoaded", async () => {
    let showGuide = false;

    try {
        showGuide = await GuidesAPI.shouldShow(GUIDE_SLUG);
    } catch (e) {
        console.error("Ошибка проверки гайда:", e);
        return;
    }

    if (!showGuide) return;

    // Ждём стабилизацию layout вместо setTimeout
    requestAnimationFrame(() => {
        requestAnimationFrame(startOnboarding);
    });
});
</script>
<style>
/* =====================================================
   ONBOARDING POPOVER BUTTON LAYOUT
===================================================== */

/* контейнер кнопок */
.onboarding-popover .driver-popover-footer {
    display: flex !important;
    align-items: center;
    width: 100%;
}

/* группа кнопок */
.onboarding-popover .driver-popover-navigation-btns {
    display: flex;
    width: 100%;
}

/* КНОПКА НАЗАД — слева */
.onboarding-popover .driver-popover-prev-btn {
    margin-right: auto !important;
}

/* КНОПКА ДАЛЕЕ — справа */
.onboarding-popover .driver-popover-next-btn {
    margin-left: auto !important;
}

/* кнопка закрытия (если есть) остаётся справа */
.onboarding-popover .driver-popover-close-btn {
    margin-left: 8px;
}



  /* =====================================================
   DRIVER.JS — ONBOARDING POPOVER ONLY
   (затрагивает ТОЛЬКО гайд)
===================================================== */

.onboarding-popover {
    max-width: 420px;     /* больше стандартного */
    width: min(92vw, 420px);

    padding: 18px 20px;
    border-radius: 14px;

    font-size: 15px;
    line-height: 1.45;
}


/* ---------- заголовок ---------- */

.onboarding-popover .driver-popover-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 8px;
}


/* ---------- текст ---------- */

.onboarding-popover .driver-popover-description {
    font-size: 15px;
    line-height: 1.5;
}


/* ---------- кнопки ---------- */

.onboarding-popover .driver-popover-footer button {
    min-height: 40px;
    padding: 8px 14px;
    font-size: 14px;
    border-radius: 8px;
}


/* =====================================================
   DESKTOP — чуть больше
===================================================== */

@media (min-width: 1024px) {

    .onboarding-popover {
        max-width: 480px;
        padding: 22px 24px;
        font-size: 16px;
    }

    .onboarding-popover .driver-popover-title {
        font-size: 20px;
    }

    .onboarding-popover .driver-popover-description {
        font-size: 16px;
    }
}


/* =====================================================
   MOBILE — значительно крупнее
===================================================== */

@media (max-width: 640px) {

    .onboarding-popover {
        width: calc(100vw - 24px);
        max-width: none;

        padding: 20px 18px;
        border-radius: 16px;

        font-size: 16px;
    }

    .onboarding-popover .driver-popover-title {
        font-size: 19px;
    }

    .onboarding-popover .driver-popover-description {
        font-size: 16px;
        line-height: 1.55;
    }

    .onboarding-popover .driver-popover-footer {
        margin-top: 14px;
    }

    .onboarding-popover .driver-popover-footer button {
        min-height: 44px; /* удобный touch target */
        font-size: 15px;
        padding: 10px 16px;
    }
}

/* =====================================================
   ONBOARDING ICON STYLE (Driver.js only)
===================================================== */

.onboarding-popover .onboarding-icon {
    margin-right: 8px;
    font-size: 16px;
    vertical-align: middle;
    opacity: 0.9;
}
.onboarding-popover {
    transform-origin: top center;
}
</style>

{% include 'hwyd/scripts.html' %}

</body>
</html>
