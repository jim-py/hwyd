{% load static %}
{% load tags %}

<script>
let currentModal = null;

// открыть модалку
function openModal(modalId) {
    currentModal = document.getElementById(modalId);
    if (currentModal) {
        currentModal.style.display = 'flex';
    }
}

// закрыть текущую модалку
function closeModal() {
    if (currentModal) {
        currentModal.style.display = 'none';
        currentModal = null;
    }
}

// клик вне окна — закрытие
function onModalClick(event) {
    if (!currentModal) return;

    const modalContent = currentModal.querySelector('.modal-content');

    if (modalContent && !modalContent.contains(event.target)) {
        closeModal();
    }
}
</script>


{# Скрипты таблицы  - Костыль#}
{% if request.user_agent.is_mobile %}
<script>
  function updateScale() {
    const baseWidth = 390;       // базовая ширина экрана для масштаба 1.277
    const baseScale = 1.27;
    const viewportWidth = window.innerWidth;
    const scale = (viewportWidth / baseWidth) * baseScale;

    el = document.getElementById('myTable');
    el.style.transform = `scale(${scale})`;
    {% if settings.showCreateActivity %}
    el = document.getElementById('createActivity');
    el.style.transform = `scale(${scale})`;
    {% endif %}
    {% if settings.showCreateActivityGroup %}
    el = document.getElementById('createActivityGroup');
    el.style.transform = `scale(${scale})`;
    {% endif %}
  }

  window.addEventListener('resize', updateScale);
  window.addEventListener('load', updateScale);
  {% if settings.showCreateActivity %}
    const baseWidth = 390;
    const baseScale = 1.27;
    const viewportWidth = window.innerWidth;
    const scale = (viewportWidth / baseWidth) * baseScale;

    const tableOffsetHeight = document.getElementById('myTable').offsetHeight;
    document.getElementById('createActivity').style.marginTop = (tableOffsetHeight * scale - tableOffsetHeight + 10) + 'px';
    {% endif %}
</script>
{% endif %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const numberElements = document.querySelectorAll('.number');
        numberElements.forEach(function (element) {
            element.addEventListener('click', function () {
                let newValue = parseInt(element.textContent) + 10;
                const brightness = 255 - (newValue / 100) * 255;
                element.textContent = newValue.toString();
                element.style.backgroundColor = "rgba(0, 255, 0, " + (newValue / 100) + ")";
                element.style.color = "rgb(" + (brightness) + ", " + (brightness) + ", " + (brightness) + ")";
            });
        });
    });

    {% if settings.showTabs %}
    document.addEventListener('DOMContentLoaded', function () {
        const bars = document.querySelectorAll('.progress-bar');

        bars.forEach(bar => {
            const percent = parseFloat(bar.dataset.width) || 0;

            const color = getGradientColor(percent);
            const textColor = getTextColorForBackground(color);

            bar.style.backgroundColor = color;
            bar.style.color = textColor;
        });
    });
    {% endif %}

    function getGradientColor(percent) {
        const colors = [
            [224, 102, 102],
            [220, 146, 116],
            [249, 203, 156],
            [247, 244, 202],
            [187, 201, 173]
        ];

        if (percent < 1)
            percent = 0
        else if (percent > 99)
            percent = 100

        const stepCount = colors.length - 1;
        const step = 100 / stepCount;
        const index = Math.min(Math.floor(percent / step), stepCount - 1);

        const colorStart = colors[index];
        const colorEnd = colors[index + 1];

        const localPercent = (percent - index * step) / step;

        const r = Math.round(colorStart[0] + (colorEnd[0] - colorStart[0]) * localPercent);
        const g = Math.round(colorStart[1] + (colorEnd[1] - colorStart[1]) * localPercent);
        const b = Math.round(colorStart[2] + (colorEnd[2] - colorStart[2]) * localPercent);

        return `rgb(${r}, ${g}, ${b})`;
    }

    function getTextColorForBackground(rgb) {
        const match = rgb.match(/\d+/g);
        const r = parseInt(match[0]);
        const g = parseInt(match[1]);
        const b = parseInt(match[2]);

        const brightness = (r * 299 + g * 587 + b * 114) / 1000;

        return brightness > 128 ? '#333' : '#fff';
    }

    for (let elem of document.querySelectorAll('div.divClick')) {
        elem.addEventListener('click', function () {
            const object = $(this);
            let currentDate = new Date();
            let currentDay = currentDate.getDate() - 1;
            let divId = this.id;

            object.toggleClass('on');

            {#let counter = '#number' + divId.split('-').pop(), newValue;#}
            {#const element = document.querySelector(counter);#}
            {#let amountPercent = 100 / {{ range_activities|length }};#}

            let cellChecked = this.classList.contains('on')
            if (cellChecked) {
                {#newValue = Math.floor(parseInt(element.textContent) + amountPercent);#}
                {% if settings.vanishing != "off" %}
                    {% if settings.vanishing == "smooth" %}
                        if (divId.includes('-' + currentDay.toString())) {
                            setTimeout(function () {
                                object.parent().parent().fadeOut(1000);
                            }, 1000);
                        }
                    {% elif settings.vanishing == "sharp" %}
                        if (divId.includes('-' + currentDay.toString())) {
                            object.parent().parent().fadeOut(700);
                        }
                    {% endif %}
                {% endif %}
            }
            {# } else {#}
            {#    newValue = Math.floor(parseInt(element.textContent) - amountPercent);#}
            {# }#}

            {#const brightness = Math.floor(255 - (newValue / 100) * 255);#}
            {#element.textContent = newValue.toString();#}
            {#element.style.backgroundColor = "rgba(0, 255, 0, " + (newValue / 100) + ")";#}
            {#element.style.color = "rgb(" + brightness + ", " + brightness + ", " + brightness + ")";#}

            {% if settings.onSounds %}
                let music
                if (object.hasClass('on')) {
                    music = new Audio("{% static 'on.MP3' %}");
                } else {
                    music = new Audio("{% static 'off.MP3' %}");
                }
                music.volume = 0.5;
                music.play();
            {% endif %}
            let group_id = $(this.parentNode.parentNode)[0].className.match(/[0-9-]+/g)[0].split('-')[0]
            if (group_id) {
                let day = Number(this.id.split('-')[1]) + 1, newWidth, progress
                let groups_progress_add = {% progress_cell_add %};
                {% if request.user_agent.is_mobile %}
                    let tmp = {{ range_days }};
                    progress = document.querySelector('tr.isGroup' + group_id).children[tmp.indexOf(day - 1)].children[0]
                {% else %}
                    progress = document.querySelector('tr.isGroup' + group_id).children[day].children[0]
                {% endif %}
                let progress_bar = progress.children[0]

                {% if settings.showTabs %}
                let width = progress_bar.getAttribute('data-width')
                if (progress_bar.style.width === '0%') {
                    $(progress).toggleClass('off')
                    $(progress_bar).toggleClass('off')
                } else if (progress_bar.style.width === '100%') {
                    $(progress).toggleClass('full')
                    $(progress_bar).toggleClass('full')
                } else {
                    $(progress).toggleClass('full')
                    $(progress_bar).toggleClass('full')
                }
                {% else %}
                let width = progress_bar.style.width
                if (progress_bar.style.width === '0%') {
                    $(progress).toggleClass('off')
                    $(progress_bar).toggleClass('off')
                } else if (progress_bar.style.width === '100%') {
                    $(progress).toggleClass('full')
                    $(progress_bar).toggleClass('full')
                } else {
                    $(progress).toggleClass('notFull')
                    $(progress_bar).toggleClass('notFull')
                }
                {% endif %}

                if (object.hasClass('on')) {
                    {% if not settings.showTabs %}
                    newWidth = Number(width.substring(0, width.length - 1)) + groups_progress_add[group_id][day - 1];
                    if (newWidth > 99)
                        progress_bar.style.width = '100%'
                    else
                        progress_bar.style.width = `${newWidth}%`
                    {% else %}
                    newWidth = Number(width) + groups_progress_add[group_id][day - 1];
                    if (newWidth > 1)
                        progress_bar.style.width = '100%'
                    if (newWidth > 99)
                        progress_bar.setAttribute('data-width', 100)
                    else
                        progress_bar.setAttribute('data-width', newWidth)
                    
                    const color = getGradientColor(newWidth);
                    const textColor = getTextColorForBackground(color);
                    progress_bar.style.backgroundColor = color;
                    progress_bar.style.color = textColor;

                    if (newWidth > 1)
                        progress_bar.textContent = `${Math.round(newWidth)}`
                    else
                        progress_bar.textContent = ''
                    {% endif %}
                } else {
                    {% if not settings.showTabs %}
                    newWidth = Number(width.substring(0, width.length - 1)) - groups_progress_add[group_id][day - 1];
                    if (newWidth < 1)
                        progress_bar.style.width = '0%'
                    else
                        progress_bar.style.width = `${newWidth}%`
                    {% else %}
                    newWidth = Number(width) - groups_progress_add[group_id][day - 1];
                    if (newWidth < 1) {
                        progress_bar.setAttribute('data-width', 0)
                        progress_bar.style.width = '0%'
                    }
                    else
                        progress_bar.setAttribute('data-width', newWidth)

                    const color = getGradientColor(newWidth);
                    const textColor = getTextColorForBackground(color);
                    progress_bar.style.backgroundColor = color;
                    progress_bar.style.color = textColor;
                    
                    if (newWidth > 1)
                        progress_bar.textContent = `${Math.round(newWidth)}`
                    else
                        progress_bar.textContent = ''
                    {% endif %}
                }

                {% if settings.showTabs %} 
                if (newWidth < 1) {
                    $(progress).addClass('off')
                    $(progress_bar).addClass('off')
                } else if (newWidth > 99) {
                    $(progress).addClass('full')
                    $(progress_bar).addClass('full')
                } else {
                    $(progress).addClass('full')
                    $(progress_bar).addClass('full')
                }
                {% else %}
                if (newWidth < 1) {
                    $(progress).addClass('off')
                    $(progress_bar).addClass('off')
                } else if (newWidth > 99) {
                    $(progress).addClass('full')
                    $(progress_bar).addClass('full')
                } else {
                    $(progress).addClass('notFull')
                    $(progress_bar).addClass('notFull')
                }
                {% endif %}
            }

            vibrateOrHaptic();

            $.ajax({
                type: 'POST',
                url: '{% url 'check_cell' date %}',
                data:
                    {
                        checkboxToCheck: elem.id,
                        csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                    }
            })
        })
        elem.oncontextmenu = function (e) {
            e.preventDefault();
            let dialog = document.getElementById('dialogCell');
            document.querySelector('input#cellNum').value = e.target.id
            $.ajax({
                type: 'POST',
                url: '{% url 'get_comments' date %}',
                data:
                    {
                        cell: e.target.id,
                        csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                    }
            }).done(function (data) {
                data = data.split('|')[e.target.id.split('-')[1]].split('*');
                document.querySelector('input#symbolsOnCell').value = data[0]
                document.querySelector('textarea#commentOnCell').value = data[1]
            });
            dialog.showModal();
        }
    } //При заходе на сайт добавляет действия на нажатие привычки и проставляет комментарии
</script>

{# Тоже что-то #}
<script>
    function submitActivitySettings() {
        let data = ''
        for (let elem of document.querySelectorAll('.thisDay')) {
            if ($(elem).hasClass('on'))
                data += 'True '
            else
                data += 'False '
        }
        document.querySelector('[id=inputCells]').value = data;
        document.querySelector('form[id=formActivitySettings]').submit();
    }

    for (let elem of document.querySelectorAll('[id*=day]')) {
        elem.addEventListener("click", function (e) {
            $(e.target).toggleClass('on')
        })
    }

    for (let elem of document.querySelectorAll('[id*=weekday]')) {
        elem.addEventListener("click", function (e) {
            let lst = {{ weekdays|safe }};
            for (let elem_day of lst[e.target.getAttribute('data-day')]) {
                document.querySelector(`[id=day${elem_day}]`).click()
            }
        })
    }

    {% if settings.showActivityDayLight %}
    // Выделение дня при наведении на клетку
    $(document).ready(function () {
        const selector = '.table th p';
        $('.table td').hover(function () {
            let columnIndex = $(this).index();
            if (columnIndex !== 0) {
                $(selector).eq(columnIndex).css('box-shadow', '0 0 3px -1px rgb(0, 0, 0) inset');
                $(selector).eq(columnIndex).css('border', '1px solid black');
            }
        }, function () {
            $(selector).css('box-shadow', '');
            $(selector).css('border', '');
        });
    });
    {% endif %}

    {% if not settings.showTabs %} 
    document.querySelector('[id=closeSettingsActivity]').addEventListener('click', function (event) {
        let paragraph = event.target.parentNode.parentNode.querySelector('input.colorBackgroundForm').data;
        paragraph.style.backgroundColor = '';
        paragraph.style.color = '';
        for (let elem of paragraph.parentNode.parentNode.children)
            try {
                if ($(elem.children[0]).hasClass('on'))
                    elem.children[0].style.backgroundColor = '';
                if ($(elem.children[0]).hasClass('full') || $(elem.children[0]).hasClass('notFull'))
                    elem.children[0].children[0].style.backgroundColor = $(elem.children[0].children[0]).data('bgcolor');
            } catch {
            }
    })
    {% endif %} 
</script>

{# ОТКРЫТИЕ/РАСКРЫТИЕ ГРУПП #}
<script>
    {% if settings.enableOpenCloseGroups %}
        for (let stroke of document.querySelectorAll('td[class*="isGroup"]')) {
            stroke.addEventListener("click", function (e) {
                let group_id = e.target.getAttribute('data-pk')
                if ($(this).hasClass('expand')) {
                    for (let elem of document.querySelectorAll(`tr[class*=group${group_id}]`)) {
                        elem.style.display = ''
                    }
                } else {
                    for (let elem of document.querySelectorAll(`tr[class*=group${group_id}]`)) {
                        elem.style.display = 'none'
                    }
                }
                $(this).toggleClass('expand');
                $.ajax({
                    type: 'POST',
                    url: '{% url 'open_group' %}',
                    data:
                        {
                            openedGroup: group_id,
                            csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                        }
                })
            });
        }
    {% endif %}
</script>

{# ОТКРЫВАЕТ МОДАЛЬНОЕ ОКНО ПО НАЖАТИЮ НА МЕСЯЦ #}
<script>
    document.querySelector('p.headParagraph.changeParagraph.main').onclick = function (e) {
        e.preventDefault();
        let dialog = document.getElementById('dialogHead');
        dialog.showModal();
    }
</script>

{# ОБРАБОТКА ВВЕДЁННОГО ЦВЕТА АКТИВНОСТИ И ТЕКСТА В НАСТРОЙКАХ АКТИВНОСТИ #}
<script>
    // Функция для обработки
    function handleColorInputChange(inputId, outputId) {
        document.querySelector(inputId).addEventListener('input', function (e) {
            const evt = document.createEvent('HTMLEvents');
            evt.initEvent("input", true, true);

            // Проверяем, соответствует ли введенное значение шестнадцатеричному коду цвета
            if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                document.querySelector(outputId).value = e.target.value;
                document.querySelector(outputId).dispatchEvent(evt);
            }
        });
    }

    // Обрабатываем изменения цвета фона и текста активности
    handleColorInputChange('input#colorBackgroundFormText', 'input#colorBackgroundForm');
    handleColorInputChange('input#colorTextFormText', 'input#colorTextForm');
</script>





{# ПРАВЫЙ КЛИК НА АКТИВНОСТЬ, ЗАПОЛНЕНИЕ ПОЛЕЙ МОДАЛЬНОГО ОКНА #}
{% comment %} Отформатировал {% endcomment %}
<script>
    /* ===============================
    ПОДКЛЮЧЕНИЕ ПРАВОЙ КНОПКИ КЛАВИШИ НА АКТИВНОСТИ
    ================================ */
    document.addEventListener("contextmenu", (e) => {
        const target = e.target.closest("td.header");

        if (!target) return;

        rightClick(e);
    });


    /* ===============================
    CACHE DOM (один раз)
    ================================ */

    const dialog = document.getElementById("dialog");

    const UI = {
        title: dialog.querySelector(".dialog__title"),
        form: document.getElementById("formActivitySettings"),

        activityPk: dialog.querySelector('input[name="activityPk"]'),
        activityName: document.getElementById("activityName"),

        colorBg: document.getElementById("colorBackgroundForm"),
        colorBgText: document.getElementById("colorBackgroundFormText"),

        colorText: document.getElementById("colorTextForm"),
        colorTextText: document.getElementById("colorTextFormText"),

        beginDay: document.getElementById("beginDay"),
        endDay: document.getElementById("endDay"),

        sections: {
            onOffDays: document.querySelector(".onOffDaysDiv"),
            weekdays: document.querySelector(".onOffWeekdays"),
            grid: document.querySelector(".grid-container"),
            repaint: document.querySelector(".repaintActivities"),
            addToGroup: document.querySelector(".addActivityToGroup"),
            activateDays: document.querySelector(".activateDayOfActivity"),
            beginDay: document.querySelector(".beginDay"),
            endDay: document.querySelector(".endDay"),
        },

        labels: {
            name: document.getElementById("activityNameLabel"),
        },

        hrs: {
            up: document.getElementById("upHr"),
            down: document.getElementById("downHr"),
        }
    };


    /* ===============================
    DATA CACHE
    ================================ */

    const ACTIVITIES = {{ jsonActivities|safe }};
    const activityMap = new Map(
        ACTIVITIES.map(a => [a.name, a])
    );


    /* ===============================
    HELPERS
    ================================ */

    function show(el, state = true, display = "block") {
        el.style.display = state ? display : "none";
    }

    function setMargins(size) {
        UI.hrs.up.style.margin = size;
        UI.hrs.down.style.margin = size;
    }


    /* ===============================
    FILL FORM
    ================================ */

    function fillForm(activity, targetEl, type) {

        UI.title.innerText = `Настройка ${type}`;

        UI.activityPk.value = activity.id;
        UI.activityName.value = activity.name;

        UI.colorBg.value = activity.backgroundColor;
        UI.colorBgText.value = activity.backgroundColor;

        UI.colorText.value = activity.color;
        UI.colorTextText.value = activity.color;

        UI.beginDay.value = activity.beginDay + 1;
        UI.endDay.value = activity.endDay + 1;

        // сохраняем ссылку на исходный элемент (как у тебя)
        UI.colorBg.data = targetEl;
        UI.colorText.data = targetEl;
    }


    /* ===============================
    ACTIVITY MODE UI
    ================================ */

    function setupActivityMode(activity) {

        const days = activity.onOffCells.split(" ");

        for (let i = 0; i < days.length; i++) {
            const dayEl = document.getElementById(`day${i + 1}`);
            if (!dayEl) continue;
            dayEl.classList.remove("on");

            if (days[i] === "True") {
                dayEl.click();
            }
        }

        show(UI.sections.onOffDays, true, "inline-block");
        show(UI.sections.weekdays, true, "flex");
        show(UI.sections.grid, false);
        show(UI.sections.beginDay, true, "flex");
        show(UI.sections.endDay, true, "flex");

        show(UI.sections.repaint, false);
        show(UI.sections.addToGroup, false);
        show(UI.sections.activateDays, true);

        setMargins("10px");
        UI.labels.name.innerText = "Название активности:";
    }


    /* ===============================
    GROUP MODE UI
    ================================ */

    function setupGroupMode(activity, connections) {

        document
            .querySelectorAll('[id*=activityToGroup]')
            .forEach(input => {

                input.checked = false;
                input.parentNode.classList.remove("activityOn");

                if (connections.includes(Number(input.name))) {
                    input.checked = true;
                    input.parentNode.classList.add("activityOn");
                }
            });

        show(UI.sections.onOffDays, false);
        show(UI.sections.weekdays, false);
        show(UI.sections.grid, true, "grid");
        show(UI.sections.beginDay, false);
        show(UI.sections.endDay, false);

        show(UI.sections.repaint, true);
        show(UI.sections.addToGroup, true);
        show(UI.sections.activateDays, false);

        setMargins("20px");
        UI.labels.name.innerText = "Название группы:";
    }


    /* ===============================
    NAME MARQUEE ANIMATION
    ================================ */

    function animateOverflowNames() {

        document.querySelectorAll(".spanActivityName").forEach(span => {

            const parent = span.parentElement;

            const divSize = parent.offsetWidth - 10;
            const spanSize = span.offsetWidth + 10;

            if (divSize - spanSize < 0) {
                span.animate(
                    [
                        { transform: `translateX(${divSize - spanSize}px)` },
                        { transform: "translateX(0)" }
                    ],
                    {
                        direction: "alternate-reverse",
                        duration: 3000,
                        iterations: Infinity
                    }
                );
            } else {
                parent.style.justifyContent = "center";
            }
        });
    }


    /* ===============================
    MAIN HANDLER
    ================================ */

    function rightClick(e) {
        e.preventDefault();

        const name = e.target.dataset.name;
        const type = e.target.dataset.type;

        const activity = activityMap.get(name);
        if (!activity) return;

        const connections =
            JSON.parse(e.target.dataset.conn || "[]");

        fillForm(activity, e.target, type);

        if (type === "активности") {
            setupActivityMode(activity);
        } else {
            setupGroupMode(activity, connections);
        }

        dialog.showModal();
        animateOverflowNames();
    }
</script>





{# Перетаскивание строк #}
<script>
    let fixHelper = function (e, ui) {
        ui.children().each(function () {
            $(this).width($(this).width());
        });
        return ui;
    };  // Корректирует отображение при перетаскивании

    let stop = function (e, ui) {
        let elem = ui.item[0]
        let elem_class = elem.className
        let prev_elem = elem.previousElementSibling
        let next_elem = elem.nextElementSibling
        let groups_ids = {{ groups_ids }};
        let numbers_filter = /[0-9-]+/g

        if (elem_class.indexOf('None') >= 0) {
            {#console.log('activity')#}
            if (!((prev_elem === null) || (next_elem === null))) {
                for (let group_id of groups_ids) {
                    let prev_elem_group = prev_elem.className.indexOf('isGroup' + group_id) >= 0
                    let next_elem_activ = next_elem.className.indexOf('group' + group_id) >= 0
                    if (((prev_elem_group) && (next_elem_activ)) || ((next_elem_activ) && (next_elem_activ))) {
                        $(elem).insertBefore('tr.isGroup' + group_id)
                    }
                }
            }
        } else if (elem_class.indexOf('isGroup') >= 0) {
            {#console.log('group')#}
            if (!((prev_elem === null) || (next_elem === null))) {
                for (let group_id of groups_ids) {
                    let prev_elem_group = prev_elem.className.indexOf('isGroup' + group_id) >= 0
                    let next_elem_activ = next_elem.className.indexOf('group' + group_id) >= 0
                    if (((prev_elem_group) && (next_elem_activ)) || ((next_elem_activ) && (next_elem_activ))) {
                        $(elem).insertBefore('tr.isGroup' + group_id)
                    }
                }
            }
            for (let i in [0, 1])
                for (let activity_group of document.querySelectorAll(`tr[class*=group${elem_class.match(numbers_filter)[0]}]`))
                    $(activity_group).insertAfter(elem)
        } else if (elem_class.indexOf('group') >= 0) {
            {#console.log('activityGroup')#}
            if (prev_elem === null)
                $(elem).insertAfter('tr.isGroup' + elem_class.match(numbers_filter)[0].split('-')[0])
            else
                if (prev_elem.className.split('-')[0] !== elem_class.split('-')[0])
                    $(elem).insertAfter('tr.isGroup' + elem_class.match(numbers_filter)[0].split('-')[0])
        }
        let activities = []
        for (let activity of document.querySelectorAll('p[id*=p]')) {
            activities.push(activity.getAttribute('data-name'))
        }
        setTimeout(timeout, 0);

        function timeout() {
            $.ajax({
                type: 'POST',
                url: '{% url 'by_date' date %}',
                data:
                    {
                        activities: activities,
                        csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                    }
            })
        }
    };  // Отправляет порядок активностей после окончания перетаскивания

    $('.sortable-table tbody').sortable({
        handle: '.paragraph',
        helper: fixHelper,
        stop: stop,
        scroll: false,
        revert: 200
    });  // Настройка перетаскивания
</script>

{# ОТПРАВКА ФОРМ СОЗДАНИЯ АКТИВНОСТЕЙ И ВЫБОРА МЕСЯЦА В КАЛЕНДАРЕ #}
<script>
    {% if settings.showCalendar %}
        document.getElementById('chooseDate').addEventListener("change", function () {
            document.getElementById("chooseDate").submit();
        });
    {% endif %}  //Отправка формы выбора месяца
</script>

{# Динамическое изменение цветов #}
<script>
    try {
        //Динамическое изменение цвета заголовка таблицы
        let tmpElem = document.getElementById('tableHeadColor*changeParagraph')
        tmpElem.addEventListener("input", function (event) {
            for (let elem of document.querySelectorAll('p.' + event.target.id.split('*')[1])) {
                elem.style.backgroundColor = event.target.value;
            }
        });

        //Динамическое изменение цвета заголовка таблицы выходных
        tmpElem = document.getElementById('tableHeadColorWeekend')
        tmpElem.addEventListener("input", function (event) {
            for (let elem of document.querySelectorAll('p.weekend')) {
                elem.style.backgroundColor = event.target.value;
            }
        });

        //Динамическое изменение цвета текста заголовка таблицы
        tmpElem = document.getElementById('tableHeadTextColor*changeParagraph')
        tmpElem.addEventListener("input", function (event) {
            for (let elem of document.querySelectorAll('p.' + event.target.id.split('*')[1])) {
                elem.style.color = event.target.value;
            }
            for (let elem of document.querySelectorAll('p.weekend')) {
                elem.style.color = event.target.value;
            }
        });

        //Динамическое изменение заднего фона сайта
        tmpElem = document.getElementById('backgroundColor')
        tmpElem.addEventListener("input", function (event) {
            document.body.style.backgroundColor = event.target.value;
        });
    } catch {

    }

    for (let elem of document.querySelectorAll('input.colorBackgroundForm')) {
        elem.addEventListener("input", function (event) {
            event.target.data.style.backgroundColor = event.target.value;
            document.querySelector('input#colorBackgroundFormText').value = event.target.value;
        });  //Изменение цвета активности
        {% if not settings.showTabs %}
        elem.addEventListener("input", function (event) {
            for (let elem of event.target.data.parentNode.parentNode.children)
                try {
                    if ($(elem.children[0]).hasClass('on'))
                        elem.children[0].style.backgroundColor = event.target.value;
                    if ($(elem.children[0]).hasClass('full') || $(elem.children[0]).hasClass('notFull'))
                        elem.children[0].children[0].style.backgroundColor = event.target.value;
                } catch {
                }
            });  //Изменение цвета клеток активности
        {% endif %} 
    }  //Динамическое обновление цвета фона активности

    for (let elem of document.querySelectorAll('input.colorTextForm')) {
        elem.addEventListener("input", function updateColorText(event) {
            event.target.data.style.color = event.target.value;
        });
    }  //Динамическое обновление цвета текста активности
</script>

{# СОХРАНЕНИЕ НАСТРОЕК #}
<script>
    function btnSaveSettings() {
        const checkboxes = [
            "showCalendar", "showCreateActivity", "showDeleteActivity",
            "showDeleteAllActivities", "showCreateActivityGroup",
            "onSounds", "showRowColumnLight", "showActivityDayLight", "showOpenAllGroups",
            "showTabs"
        ];
        document.querySelector("#data").value = checkboxes.map(checkboxId =>
            document.querySelector(`#${checkboxId}`).checked
        );
        document.getElementById('settingsGlobal').submit();
    }
</script>
<script>
{#function swapRows() {#}
{#    let rows = $(".sortable-table tbody tr");#}
{#    rows.first().before(rows.last());#}
{# } #}
{#document.querySelector('#buttonUp').addEventListener('click', function() {#}
{#    swapRows();#}
{# }); #}

$("#dialogHead, #dialog").draggable({
    handle: '.modal__header',
    cursor: 'move'
});

for (let elem of document.querySelectorAll('.deleteActivityButt')) {
    elem.addEventListener('click', function (evt) {
        let pk = evt.target.getAttribute('data-pk')
        $.ajax({
            type: 'POST',
            url: '{% url 'delete_activity' %}',
            data:
                {
                    pk: pk,
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                }
        }).done(function () {
            $(evt.target.parentNode.parentNode.parentNode.parentNode.parentNode).remove()
            $(document.querySelector(`#activityToGroup${pk}`).parentNode).remove()
        });
    })
}
{% if range_activities and settings.showDeleteAllActivities %}
document.querySelector('#deleteAll').addEventListener('click', function (evt) {
        $.ajax({
            type: 'POST',
            url: '{% url 'delete_all' date %}',
            data:
                {
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                }
        }).done(function () {
            for (let elem of document.querySelectorAll('tbody tr')) {
                elem.remove()
            }
            $('#deleteAll')[0].style.display = 'none'
            $('#btnActLastMonth')[0].parentElement.style.display = 'inline'
            $('#openAll')[0].style.display = 'none'
        });
    })
{% endif %}

function any(iterable) {
    for (let index = 0; index < iterable.length; index++) {
        if (iterable[index]) return true;
    }
    return false;
}

document.querySelector('#openAll').addEventListener('click', function (evt) {
    $.ajax({
        type: 'POST',
        url: '{% url 'open_all' date %}',
        data:
            {
                csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
            }
    }).done(openAllGroups);
})
</script>
<script src="{% static 'js/html2canvas.js' %}"></script>
<script>
    {% comment %} window.takeScreenShot = function () {
        openAllGroups();
  const myTable = document.getElementById("myTable");
  const tableWidth = myTable.offsetWidth;
  const tableHeight = myTable.offsetHeight;

  html2canvas(myTable, {
        backgroundColor: '{{ settings.backgroundColor }}',
        allowTaint: true,
        useCORS: true,
        width: tableWidth,
        height: tableHeight,
  })
    .then((canvas) => {
      document.body.appendChild(canvas);
      let canvasObj = document.querySelector('canvas'); // Получить ссылку на элемент canvas
        canvasObj.id = "asdf";
        canvasObj.style.display = "none";
        let dataURL = canvasObj.toDataURL('image/png'); // Получить данные из canvas в формате PNG
                let img = new Image();
                img.src = dataURL;

                // Создать временный элемент для хранения изображения
                let tempInput = document.createElement('input');
                tempInput.type = 'text';
                tempInput.value = dataURL;

                // Добавить элемент в DOM (он не будет видимым на странице)
                document.body.appendChild(tempInput);

                // Выделить текст внутри элемента
                tempInput.select();

                // Копировать выделенный текст в буфер обмена
                document.execCommand('copy');

                // Удалить временный элемент
                document.body.removeChild(tempInput);

                setTimeout(downloadTable, 300)

        function downloadTable() {
            let canvas = document.getElementById("asdf");
            let ctx = canvas.getContext("2d");
            let imageData = canvas.toDataURL("image/png");
            let tempLink = document.createElement("a");
            tempLink.href = imageData;
            tempLink.download = `productivum${Date.now()}.png`;
            document.body.appendChild(tempLink);
            tempLink.click();
            document.body.removeChild(tempLink);
            document.getElementById("myTable").style.backgroundColor = ''
            setTimeout(function () {
                window.location.reload();
            }, 1000);
        }
    })
}; {% endcomment %}


	{% comment %} window.onload = function() {

        document.getElementById("screenShot").onclick = function () {
            openAllGroups();
            const myTable = document.getElementById("myTable");
            const tableWidth = myTable.offsetWidth;
            const tableHeight = myTable.offsetHeight;

            html2canvas(myTable, {
                backgroundColor: '{{ settings.backgroundColor }}',
                allowTaint: true,
                useCORS: true,
                width: tableWidth,
                height: tableHeight,
            }).then(function (canvas) {

                document.getElementById("screenShot").appendChild(canvas);
                let canvasObj = document.querySelector('canvas'); // Получить ссылку на элемент canvas
                canvasObj.id = "asdf";
                canvasObj.style.display = "none";
                let dataURL = canvasObj.toDataURL('image/png'); // Получить данные из canvas в формате PNG
                let img = new Image();
                img.src = dataURL;

                // Создать временный элемент для хранения изображения
                let tempInput = document.createElement('input');
                tempInput.type = 'text';
                tempInput.value = dataURL;

                // Добавить элемент в DOM (он не будет видимым на странице)
                document.body.appendChild(tempInput);

                // Выделить текст внутри элемента
                tempInput.select();

                // Копировать выделенный текст в буфер обмена
                document.execCommand('copy');

                // Удалить временный элемент
                document.body.removeChild(tempInput);

                setTimeout(downloadTable, 300)
			});
		};


        function downloadTable() {
            let canvas = document.getElementById("asdf");
            let ctx = canvas.getContext("2d");
            let imageData = canvas.toDataURL("image/png");
            let tempLink = document.createElement("a");
            tempLink.href = imageData;
            tempLink.download = `productivum${Date.now()}.png`;
            document.body.appendChild(tempLink);
            tempLink.click();
            document.body.removeChild(tempLink);
            document.getElementById("myTable").style.backgroundColor = ''
            setTimeout(function () {
                window.location.reload();
            }, 1000);
        }
    } {% endcomment %}
function openAllGroups() {
        let groups = document.querySelectorAll('tbody td[class*=isGroup]')
        let opened = []
        let activities_clean = []
        for (let elem of document.querySelectorAll('tbody tr[class*=group]')) {
            if (!elem.className.includes('None')) {
                activities_clean.push(elem)
            }
        }
        for (let elem of activities_clean) {
            opened.push(elem.style.display)
        }
        if (any(opened) === true) {
            for (let elem of activities_clean) {
                elem.style.display = ''
            }
            for (let elem of groups) {
                if ($(elem).hasClass('expand')) {
                    $(elem).toggleClass('expand')
                }
            }
        } else {
            for (let elem of activities_clean) {
                elem.style.display = 'none'
            }
            for (let elem of groups) {
                if (!$(elem).hasClass('expand')) {
                    $(elem).toggleClass('expand')
                }
            }
        }
    }
</script>
<script>
    {% comment %} document.querySelector('#hideActivities').addEventListener('click', function () {
        let hide_activities = {{ hide_activities }};
        for (let elem of document.querySelectorAll('p.paragraph')) {
            for (let pk of hide_activities) {
                if (pk === Number(elem.getAttribute('data-pk'))) {
                    const object = $(elem.parentNode.parentNode);
                    object.toggleClass('hide');
                }
            }
        }
    }) {% endcomment %}
    document.querySelector('#hideCompleteActivities').addEventListener('click', function () {
        let trElements = document.querySelectorAll('tbody tr'), check = true;
        let currentDate = new Date();
        let currentDay = currentDate.getDate() - 1;

        trElements.forEach(function (tr) {
            let trHide = tr.classList.contains('hide')
            let displayStyle = window.getComputedStyle(tr).getPropertyValue('display');
            if (!trHide) {
                if (displayStyle === 'none') {
                    tr.style.display = '';
                    check = false;
                }
            }
        });
        if (check === true) {
            let divElements = document.querySelectorAll('div.on');
            divElements.forEach(function (div) {
                let divId = div.id;
                if (divId.includes('-' + currentDay.toString())) {
                    let grandParent = div.parentElement.parentElement;
                    grandParent.style.display = 'none';
                }
            });
        }
    })

    document.querySelector('#selectSettings').addEventListener('change', function (evt) {
        $.ajax({
            type: 'POST',
            url: '{% url 'change_setting' %}',
            data:
                {
                    setting: evt.target.value,
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                }
        })
        setTimeout(function () {
            location.href = '{% url 'by_date' date %}';
        }, 100)
    })

    document.querySelector('#addSetting').addEventListener('click', function () {
        $.ajax({
            type: 'POST',
            url: '{% url 'add_setting' %}',
            data:
                {
                    nameSetting: document.querySelector('#nameSetting').value,
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                }
        })
        setTimeout(function () {
            location.href = '{% url 'by_date' date %}';
        }, 100)
    })

    // document.querySelector('#delSetting').addEventListener('click', function () {
    //     $.ajax({
    //         type: 'POST',
    //         url: '{% url 'delete_setting' 1 %}',
    //         data:
    //             {
    //                 csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
    //             }
    //     })
    //     setTimeout(function () {
    //         location.href = '{% url 'by_date' date %}';
    //     }, 100)
    // })

    for (let elem of document.querySelectorAll('.activityCell')) {
        elem.addEventListener('click', function () {
            $(elem).toggleClass('activityOn');
            let inputCheckbox = elem.querySelector('input');
            inputCheckbox.checked = !inputCheckbox.checked;
        })
    }

    document.addEventListener('keydown', function (event) {
        let isAltPressed = event.altKey;
        let isSPressed = event.key === 's' || event.keyCode === 83;
        if (isAltPressed && isSPressed) {
            let divButtons = document.getElementById('divButtons');
            if (divButtons) {
                divButtons.style.display = 'none';
            }
        }
    });

{#    {% if user.username == 'unbroken0886' %}#}
{#    location.reload(true);#}
{#    {% endif %}#}
</script>

<script>
    document.getElementById('downloadJson').addEventListener('click', function () {
        fetch('/habitus/export-json/')
            .then(response => response.json())
            .then(data => {
                // Создаем файл JSON для скачивания
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'data.json';
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            })
            .catch(error => console.error('Ошибка:', error));
    });
</script>

